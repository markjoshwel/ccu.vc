# Iteration 20 Log

## Metadata

- **Task ID**: US-020
- **Task Title**: Implement win condition: first player to 0 cards ends game
- **Description**: Allow games to conclude normally without relying on disconnect win.
- **Status**: completed
- **Task Completed**: Yes
- **Promise Detected**: Yes
- **Started At**: 2026-01-17T20:23:41.034Z
- **Ended At**: 2026-01-17T20:29:41.029Z
- **Duration**: 5m 59s
- **Agent**: opencode
- **Model**: opencode/glm-4.7-free
--- RAW OUTPUT ---
I'll implement US-020 to add the win condition when a player reaches 0 cards. Let me start by exploring the codebase structure.
Now I'll implement the win condition. Looking at the code, I need to:

1. Check if a player's hand becomes empty after playing a card
2. End the game and announce the winner
3. Reject further play/draw actions after game ends
Now I need to add tests for the win condition and rejection of actions post-finish. Let me add these tests:
Now I'll add tests for the win condition at the end of the test file:
Now let me run the tests and typecheck to verify the implementation:
I need to fix the failing tests. The issues are:

1. In "announce winner" test, it's not player2's turn
2. In "reject playCard" test, the card is a Wild card which requires a color choice
Let me fix this properly - I shouldn't be changing the game status in the test:
I see the issue - when player1 plays, the card they play might be a Wild card, which then requires player2 to provide a color choice. Let me fix both tests to handle this properly:
Let me use a seeded RNG to ensure the initial discard card is not a Wild card:
The test is failing because after player1 plays, the game advances turn but then player2 tries to play when the game ended. Let me fix the test to make player2 play their last card:
This is a pre-existing test issue where the random shuffle produces a Wild card as the initial discard. Let me fix it by using a seeded RNG:
All tests pass. Now let me run typecheck:
All acceptance criteria are met. Let me commit the changes:
<promise>COMPLETE</promise>

--- STDERR ---
[94m[1m| [0m[90m Glob     [0m{"pattern":"**/roomManager.ts"}
[94m[1m| [0m[90m Glob     [0m{"pattern":"**/types.ts"}
[94m[1m| [0m[90m Glob     [0m{"pattern":"**/server.ts"}
[91m[1m| [0m[90m Bash     [0mFind TypeScript files

'head' is not recognized as an internal or external command,
operable program or batch file.

[94m[1m| [0m[90m Glob     [0m{"pattern":"**/*.ts"}
[96m[1m| [0m[90m Read     [0mshared\src\index.ts
[96m[1m| [0m[90m Read     [0mserver\src\RoomManager.ts
[96m[1m| [0m[90m Read     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\src\RoomManager.ts
[96m[1m| [0m[90m Read     [0mserver\server.test.ts
[96m[1m| [0m[90m Read     [0mserver\server.test.ts
[91m[1m| [0m[90m Bash     [0mGet line count of test file


'wc' is not recognized as an internal or external command,
operable program or batch file.
[96m[1m| [0m[90m Read     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[91m[1m| [0m[90m Bash     [0mRun server tests

server test: bun test v1.3.6 (d530ed99)
server test: 
server test: server.test.ts:
server test: gameStateUpdate not received in time, checking room directly
server test: 217 |       throw new Error('Game is not in playing state');
server test: 218 |     }
server test: 219 | 
server test: 220 |     const currentPlayerId = this.playerOrder[this.currentPlayerIndex];
server test: 221 |     if (playerId !== currentPlayerId) {
server test: 222 |       throw new Error('Not your turn');
server test:                                            ^
server test: error: Not your turn
server test:       at playCard (C:\Users\mark\Works\ccu.vc\server\src\RoomManager.ts:222:38)
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2882:10)
server test: (fail) Win condition > should announce winner in gameEndedReason
server test: 240 |       throw new Error('No top card in discard pile');
server test: 241 |     }
server test: 242 | 
server test: 243 |     if (card.color === 'wild') {
server test: 244 |       if (!chosenColor) {
server test: 245 |         throw new Error('Must choose a color when playing a Wild card');
server test:                                                                             ^
server test: error: Must choose a color when playing a Wild card
server test:       at playCard (C:\Users\mark\Works\ccu.vc\server\src\RoomManager.ts:245:71)
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2909:10)
server test: (fail) Win condition > should reject playCard after game has finished [16.00ms]
server test: 
server test:  88 pass
server test:  2 fail
server test:  288 expect() calls
server test: Ran 90 tests across 1 file. [3.18s]
server test: Exited with code 1

[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[91m[1m| [0m[90m Bash     [0mRun server tests again

server test: bun test v1.3.6 (d530ed99)
server test: 
server test: server.test.ts:
server test: gameStateUpdate not received in time, checking room directly
server test: 240 |       throw new Error('No top card in discard pile');
server test: 241 |     }
server test: 242 | 
server test: 243 |     if (card.color === 'wild') {
server test: 244 |       if (!chosenColor) {
server test: 245 |         throw new Error('Must choose a color when playing a Wild card');
server test:                                                                             ^
server test: error: Must choose a color when playing a Wild card
server test:       at playCard (C:\Users\mark\Works\ccu.vc\server\src\RoomManager.ts:245:71)
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2882:10)
server test: (fail) Win condition > should announce winner in gameEndedReason
server test: 240 |       throw new Error('No top card in discard pile');
server test: 241 |     }
server test: 242 | 
server test: 243 |     if (card.color === 'wild') {
server test: 244 |       if (!chosenColor) {
server test: 245 |         throw new Error('Must choose a color when playing a Wild card');
server test:                                                                             ^
server test: error: Must choose a color when playing a Wild card
server test:       at playCard (C:\Users\mark\Works\ccu.vc\server\src\RoomManager.ts:245:71)
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2946:10)
server test: (fail) Win condition > should reject drawCard after game has finished
server test: 
server test:  88 pass
server test:  2 fail
server test:  288 expect() calls
server test: Ran 90 tests across 1 file. [3.61s]
server test: Exited with code 1

[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[91m[1m| [0m[90m Bash     [0mRun server tests again

server test: bun test v1.3.6 (d530ed99)
server test: 
server test: server.test.ts:
server test: gameStateUpdate not received in time, checking room directly
server test: 2653 |     const topCard = room.discardPile[0];
server test: 2654 |     const redCard = { color: topCard.color, value: '5' };
server test: 2655 | 
server test: 2656 |     room.players.get(playerId1)!.hand.push(redCard);
server test: 2657 | 
server test: 2658 |     expect(() => room.playCard(playerId1, redCard, 'blue')).toThrow('Cannot choose color for non-Wild cards');
server test:                                                                    ^
server test: error: expect(received).toThrow(expected)
server test: 
server test: Expected substring: "Cannot choose color for non-Wild cards"
server test: 
server test: Received function did not throw
server test: Received value: undefined
server test: 
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2658:61)
server test: (fail) Wild card and active color selection > should reject color choice for non-Wild cards
server test: 212 |     this.updateState();
server test: 213 |   }
server test: 214 | 
server test: 215 |   playCard(playerId: string, card: Card, chosenColor?: 'red' | 'yellow' | 'green' | 'blue'): void {
server test: 216 |     if (this.state.gameStatus !== 'playing') {
server test: 217 |       throw new Error('Game is not in playing state');
server test:                                                           ^
server test: error: Game is not in playing state
server test:       at playCard (C:\Users\mark\Works\ccu.vc\server\src\RoomManager.ts:217:53)
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2893:10)
server test: (fail) Win condition > should announce winner in gameEndedReason
server test: 
server test:  88 pass
server test:  2 fail
server test:  290 expect() calls
server test: Ran 90 tests across 1 file. [3.17s]
server test: Exited with code 1

[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[91m[1m| [0m[90m Bash     [0mRun server tests

server test: bun test v1.3.6 (d530ed99)
server test: 
server test: server.test.ts:
server test: gameStateUpdate not received in time, checking room directly
server test: 240 |       throw new Error('No top card in discard pile');
server test: 241 |     }
server test: 242 | 
server test: 243 |     if (card.color === 'wild') {
server test: 244 |       if (!chosenColor) {
server test: 245 |         throw new Error('Must choose a color when playing a Wild card');
server test:                                                                             ^
server test: error: Must choose a color when playing a Wild card
server test:       at playCard (C:\Users\mark\Works\ccu.vc\server\src\RoomManager.ts:245:71)
server test:       at <anonymous> (C:\Users\mark\Works\ccu.vc\server\server.test.ts:2329:10)
server test: (fail) Draw Two card effect > should make next player draw 2 cards and skip their turn in 3-player game [15.00ms]
server test: 
server test:  89 pass
server test:  1 fail
server test:  288 expect() calls
server test: Ran 90 tests across 1 file. [3.28s]
server test: Exited with code 1

[96m[1m| [0m[90m Read     [0mserver\server.test.ts
[96m[1m| [0m[90m Read     [0mserver\server.test.ts
[92m[1m| [0m[90m Edit     [0mserver\server.test.ts
[91m[1m| [0m[90m Bash     [0mRun server tests

server test: bun test v1.3.6 (d530ed99)
server test: 
server test: server.test.ts:
server test: gameStateUpdate not received in time, checking room directly
server test: 
server test:  90 pass
server test:  0 fail
server test:  291 expect() calls
server test: Ran 90 tests across 1 file. [3.19s]
server test: Exited with code 0

[91m[1m| [0m[90m Bash     [0mRun typecheck on server

error: No packages matched the filter

[91m[1m| [0m[90m Bash     [0mRun typecheck on server

$ tsc --noEmit

[91m[1m| [0m[90m Bash     [0mCheck git status and diff

On branch main
Your branch is ahead of 'origin/main' by 16 commits.
  (use "git push" to publish your local commits)

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   .ralph-tui/progress.md
	modified:   .ralph-tui/session.json
	modified:   prd.json
	modified:   server/server.test.ts
	modified:   server/src/RoomManager.ts

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	.ralph-tui/iterations/iteration-018-US-018.log
	.ralph-tui/iterations/iteration-019-US-019.log

no changes added to commit (use "git add" and/or "git commit -a")
warning: in the working copy of '.ralph-tui/progress.md', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of '.ralph-tui/session.json', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'prd.json', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'server/server.test.ts', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'server/src/RoomManager.ts', LF will be replaced by CRLF the next time Git touches it
diff --git a/.ralph-tui/progress.md b/.ralph-tui/progress.md
index f105d34..4545b73 100644
--- a/.ralph-tui/progress.md
+++ b/.ralph-tui/progress.md
@@ -186,3 +186,25 @@ Now let me run the tests and typecheck to verify the implementation:
 All tests pass and typecheck succeeds. Let me commit the changes:
 
 ---
+## âœ“ Iteration 18 - US-018: Implement Wild card and active color selection (server + client)
+*2026-01-17T20:21:02.456Z (453s)*
+
+**Status:** Completed
+
+**Notes:**
+I'll implement US-018 to add Wild card and active color selection. Let me start by exploring the codebase structure.
+Now I'll implement Wild card and active color selection. Let me start by updating the shared types to add `activeColor` and the color selection parameter.
+Now let me run the tests to verify the implementation:
+I see there are some test failures. Let me first check why `state.activeColor` is not being updated:
+All acceptance criteria have been met. Let me commit the changes:
+
+---
+## âœ“ Iteration 19 - US-019: Implement Wild Draw Four effect (server)
+*2026-01-17T20:23:39.991Z (156s)*
+
+**Status:** Completed
+
+**Notes:**
+I'll implement US-019 to add the Wild Draw Four effect. Let me explore the codebase first.
+
+---
diff --git a/.ralph-tui/session.json b/.ralph-tui/session.json
index c954101..ac9221e 100644
--- a/.ralph-tui/session.json
+++ b/.ralph-tui/session.json
@@ -3,10 +3,10 @@
   "sessionId": "e4783755-3905-4470-8efb-6fa82f4e2471",
   "status": "running",
   "startedAt": "2026-01-17T18:27:42.045Z",
-  "updatedAt": "2026-01-17T20:13:29.165Z",
-  "currentIteration": 17,
+  "updatedAt": "2026-01-17T20:23:41.056Z",
+  "currentIteration": 19,
   "maxIterations": 10,
-  "tasksCompleted": 17,
+  "tasksCompleted": 19,
   "isPaused": false,
   "agentPlugin": "opencode",
   "model": "opencode/glm-4.7-free",
@@ -120,14 +120,14 @@
       {
         "id": "US-018",
         "title": "Implement Wild card and active color selection (server + client)",
-        "status": "open",
-        "completedInSession": false
+        "status": "completed",
+        "completedInSession": true
       },
       {
         "id": "US-019",
         "title": "Implement Wild Draw Four effect (server)",
-        "status": "open",
-        "completedInSession": false
+        "status": "completed",
+        "completedInSession": true
       },
       {
         "id": "US-020",
@@ -403,12 +403,32 @@
       "durationMs": 132081,
       "startedAt": "2026-01-17T20:11:16.007Z",
       "endedAt": "2026-01-17T20:13:28.088Z"
+    },
+    {
+      "iteration": 18,
+      "status": "completed",
+      "taskId": "US-018",
+      "taskTitle": "Implement Wild card and active color selection (server + client)",
+      "taskCompleted": true,
+      "durationMs": 453292,
+      "startedAt": "2026-01-17T20:13:29.146Z",
+      "endedAt": "2026-01-17T20:21:02.438Z"
+    },
+    {
+      "iteration": 19,
+      "status": "completed",
+      "taskId": "US-019",
+      "taskTitle": "Implement Wild Draw Four effect (server)",
+      "taskCompleted": true,
+      "durationMs": 156482,
+      "startedAt": "2026-01-17T20:21:03.492Z",
+      "endedAt": "2026-01-17T20:23:39.974Z"
     }
   ],
   "skippedTaskIds": [],
   "cwd": "C:\\Users\\mark\\Works\\ccu.vc",
   "activeTaskIds": [
-    "US-018"
+    "US-020"
   ],
   "subagentPanelVisible": false
 }
\ No newline at end of file
diff --git a/prd.json b/prd.json
index 79de54b..fb19c0c 100644
--- a/prd.json
+++ b/prd.json
@@ -277,8 +277,9 @@
         "quality gate: `bun --filter server run typecheck` exits with code 0"
       ],
       "priority": 18,
-      "passes": false,
-      "notes": "Client can use a simple modal/bottom sheet to choose color."
+      "passes": true,
+      "notes": "Client can use a simple modal/bottom sheet to choose color.",
+      "completionNotes": "Completed by agent"
     },
     {
       "id": "US-019",
@@ -291,8 +292,9 @@
         "quality gate: `bun --filter server run typecheck` exits with code 0"
       ],
       "priority": 19,
-      "passes": false,
-      "notes": "Challenge rules are excluded in v1 unless added later."
+      "passes": true,
+      "notes": "Challenge rules are excluded in v1 unless added later.",
+      "completionNotes": "Completed by agent"
     },
     {
       "id": "US-020",
@@ -536,6 +538,6 @@
     }
   ],
   "metadata": {
-    "updatedAt": "2026-01-17T20:13:29.146Z"
+    "updatedAt": "2026-01-17T20:23:41.034Z"
   }
 }
\ No newline at end of file
diff --git a/server/server.test.ts b/server/server.test.ts
index 14e88db..ea33a3f 100644
--- a/server/server.test.ts
+++ b/server/server.test.ts
@@ -2317,7 +2317,13 @@ describe('Draw Two card effect', () => {
     room.addPlayer(socketId2, player2);
     room.addPlayer(socketId3, player3);
 
-    room.startGame();
+    let seed = 42;
+    const seededRng = () => {
+      seed = (seed * 1103515245 + 12345) % 0x80000000;
+      return seed / 0x80000000;
+    };
+
+    room.startGame(seededRng);
 
     const topCard = room.discardPile[0];
     const draw2Card: Card = { color: topCard.color, value: 'draw2' };
@@ -2826,3 +2832,135 @@ describe('Wild Draw Four card effect', () => {
     expect(room.deck!.size).toBe(initialDeckSize - 4);
   });
 });
+
+describe('Win condition', () => {
+  it('should end game when player plays their last card', () => {
+    const manager = new RoomManager();
+    const room = manager.createRoom();
+
+    const socketId1 = 'socket1';
+    const playerId1 = 'player1';
+    const player1 = { id: playerId1, name: 'Player 1', isReady: false, secret: 'secret1', connected: true, hand: [], handCount: 0 };
+
+    const socketId2 = 'socket2';
+    const playerId2 = 'player2';
+    const player2 = { id: playerId2, name: 'Player 2', isReady: false, secret: 'secret2', connected: true, hand: [], handCount: 0 };
+
+    room.addPlayer(socketId1, player1);
+    room.addPlayer(socketId2, player2);
+
+    room.startGame();
+
+    const topCard = room.discardPile[0];
+    const matchingCard: Card = { color: topCard.color, value: topCard.value };
+
+    room.players.get(playerId1)!.hand = [matchingCard];
+
+    room.playCard(playerId1, matchingCard);
+
+    expect(room.state.gameStatus).toBe('finished');
+    expect(room.state.gameEndedReason).toBe('Player 1 won');
+    expect(room.players.get(playerId1)!.hand).toHaveLength(0);
+  });
+
+  it('should announce winner in gameEndedReason', () => {
+    const manager = new RoomManager();
+    const room = manager.createRoom();
+
+    const socketId1 = 'socket1';
+    const playerId1 = 'player1';
+    const player1 = { id: playerId1, name: 'Alice', isReady: false, secret: 'secret1', connected: true, hand: [], handCount: 0 };
+
+    const socketId2 = 'socket2';
+    const playerId2 = 'player2';
+    const player2 = { id: playerId2, name: 'Bob', isReady: false, secret: 'secret2', connected: true, hand: [], handCount: 0 };
+
+    room.addPlayer(socketId1, player1);
+    room.addPlayer(socketId2, player2);
+
+    let seed = 42;
+    const seededRng = () => {
+      seed = (seed * 1103515245 + 12345) % 0x80000000;
+      return seed / 0x80000000;
+    };
+
+    room.startGame(seededRng);
+
+    room.currentPlayerIndex = 1;
+
+    const topCard = room.discardPile[0];
+    const matchingCard: Card = { color: topCard.color, value: topCard.value };
+
+    room.players.get(playerId2)!.hand = [matchingCard];
+
+    room.playCard(playerId2, matchingCard);
+
+    expect(room.state.gameEndedReason).toBe('Bob won');
+  });
+
+  it('should reject playCard after game has finished', () => {
+    const manager = new RoomManager();
+    const room = manager.createRoom();
+
+    const socketId1 = 'socket1';
+    const playerId1 = 'player1';
+    const player1 = { id: playerId1, name: 'Player 1', isReady: false, secret: 'secret1', connected: true, hand: [], handCount: 0 };
+
+    const socketId2 = 'socket2';
+    const playerId2 = 'player2';
+    const player2 = { id: playerId2, name: 'Player 2', isReady: false, secret: 'secret2', connected: true, hand: [], handCount: 0 };
+
+    room.addPlayer(socketId1, player1);
+    room.addPlayer(socketId2, player2);
+
+    room.startGame();
+
+    const topCard = room.discardPile[0];
+    const matchingCard: Card = { color: topCard.color, value: topCard.value };
+
+    room.players.get(playerId1)!.hand = [matchingCard];
+
+    room.playCard(playerId1, matchingCard);
+
+    expect(room.state.gameStatus).toBe('finished');
+
+    const anotherCard: Card = { color: 'red', value: '5' };
+
+    expect(() => room.playCard(playerId2, anotherCard)).toThrow('Game is not in playing state');
+  });
+
+  it('should reject drawCard after game has finished', () => {
+    const manager = new RoomManager();
+    const room = manager.createRoom();
+
+    const socketId1 = 'socket1';
+    const playerId1 = 'player1';
+    const player1 = { id: playerId1, name: 'Player 1', isReady: false, secret: 'secret1', connected: true, hand: [], handCount: 0 };
+
+    const socketId2 = 'socket2';
+    const playerId2 = 'player2';
+    const player2 = { id: playerId2, name: 'Player 2', isReady: false, secret: 'secret2', connected: true, hand: [], handCount: 0 };
+
+    room.addPlayer(socketId1, player1);
+    room.addPlayer(socketId2, player2);
+
+    let seed = 42;
+    const seededRng = () => {
+      seed = (seed * 1103515245 + 12345) % 0x80000000;
+      return seed / 0x80000000;
+    };
+
+    room.startGame(seededRng);
+
+    const topCard = room.discardPile[0];
+    const matchingCard: Card = { color: topCard.color, value: topCard.value };
+
+    room.players.get(playerId1)!.hand = [matchingCard];
+
+    room.playCard(playerId1, matchingCard);
+
+    expect(room.state.gameStatus).toBe('finished');
+
+    expect(() => room.drawCard(playerId2)).toThrow('Game is not in playing state');
+  });
+});
diff --git a/server/src/RoomManager.ts b/server/src/RoomManager.ts
index d7cfbc5..b3bb50c 100644
--- a/server/src/RoomManager.ts
+++ b/server/src/RoomManager.ts
@@ -264,6 +264,13 @@ export class Room {
     player.hand.splice(cardIndex, 1);
     this.discardPile.push(card);
 
+    if (player.hand.length === 0) {
+      this.state.gameStatus = 'finished';
+      this.state.gameEndedReason = `${player.name} won`;
+      this.updateState();
+      return;
+    }
+
     if (card.color === 'wild') {
       this.activeColor = chosenColor;
     } else {

[91m[1m| [0m[90m Bash     [0mCommit win condition implementation

warning: in the working copy of 'server/server.test.ts', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'server/src/RoomManager.ts', LF will be replaced by CRLF the next time Git touches it
[main db88a4b] Implement win condition: first player to 0 cards ends game
 2 files changed, 146 insertions(+), 1 deletion(-)

[91m[1m| [0m[90m Bash     [0mVerify commit

db88a4b Implement win condition: first player to 0 cards ends game

